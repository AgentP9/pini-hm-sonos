<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sonos Log Viewer">
    <meta name="author" content="Ivo Doehler">
    <meta name="language" content="de, german">
    <title>Sonos Logs</title>
    
    <!-- Bootstrap core CSS -->
    <link href="public/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom styles for this template -->
    <link href="public/css/custombootstrap.css" rel="stylesheet">
    <link href="public/css/custom.css" rel="stylesheet">
    
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <style>
        #logContent {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 4px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .log-controls {
            margin-bottom: 15px;
        }
        
        .log-controls .btn {
            margin-right: 5px;
        }
        
        .auto-refresh-label {
            margin-left: 10px;
            vertical-align: middle;
        }
    </style>
</head>

<body class="body-blue"> 

<!-- Navigation -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://www.sonos.de" target="_blank">
                <img src="public/img/logo.png" alt="Sonos Logo"> &nbsp;Sonos &nbsp;
            </a>
        </div>
        
        <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="status.cgi<%zone%>">Home</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="sonos2.cgi<%zone%>">Sonos-Script</a></li>
                <li><a href="settings/udp.cgi<%zone%>">Topology</a></li>
                <li><a href="settings/settings.cgi<%zone%>">Einstellungen</a></li>
                <li class="active"><a href="logs.cgi<%zone%>">Logs</a></li>
            </ul>
        </div><!--/.navbar-collapse -->
    </div><!-- /.container -->
</div><!-- /.navbar -->

<!-- Main Content -->
<div class="container center1 col-md-10" id="content"> 
    <legend>Log Viewer</legend>
    
    <div class="log-controls">
        <button type="button" id="refreshBtn" class="btn btn-primary">
            <span class="glyphicon glyphicon-refresh"></span> Refresh
        </button>
        <button type="button" id="clearBtn" class="btn btn-warning">
            <span class="glyphicon glyphicon-trash"></span> Clear Display
        </button>
        <label class="auto-refresh-label">
            <input type="checkbox" id="autoRefresh" checked> Auto-refresh every 
            <select id="refreshInterval" class="form-control" style="display: inline-block; width: auto;">
                <option value="2">2</option>
                <option value="5" selected>5</option>
                <option value="10">10</option>
                <option value="30">30</option>
            </select> seconds
        </label>
        <span class="pull-right">
            Lines: 
            <select id="numLines" class="form-control" style="display: inline-block; width: auto;">
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
                <option value="500">500</option>
                <option value="all">All</option>
            </select>
        </span>
    </div>
    
    <div id="logContent">Loading logs...</div>
</div>

<!-- JavaScript -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="public/js/bootstrap.min.js"></script>

<script type="text/javascript">
'use strict';

// ========================================
// Global Variables
// ========================================
let autoRefreshTimer = null;
let lastLogContent = '';

// ========================================
// Log Viewer Functions
// ========================================

/**
 * Loads log content from the server
 */
function loadLogs() {
    const numLines = $('#numLines').val();
    const url = numLines === 'all' 
        ? 'logs.cgi?getlogs=1' 
        : 'logs.cgi?tail=1&getlogs=1&lines=' + numLines;
    
    $.ajax({
        type: "GET",
        url: url,
        success: function(data) {
            if (data !== lastLogContent) {
                lastLogContent = data;
                $('#logContent').text(data);
                
                // Auto-scroll to bottom
                const logDiv = document.getElementById('logContent');
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            $('#logContent').html('<span style="color: #ff6b6b;">Error loading logs: ' + textStatus + '</span>');
        }
    });
}

/**
 * Clears the log display
 */
function clearDisplay() {
    $('#logContent').text('Display cleared. Click Refresh to reload logs.');
    lastLogContent = '';
}

/**
 * Starts the auto-refresh timer
 */
function startAutoRefresh() {
    stopAutoRefresh();
    if ($('#autoRefresh').is(':checked')) {
        const interval = parseInt($('#refreshInterval').val()) * 1000;
        autoRefreshTimer = window.setInterval(loadLogs, interval);
    }
}

/**
 * Stops the auto-refresh timer
 */
function stopAutoRefresh() {
    if (autoRefreshTimer !== null) {
        window.clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
    }
}

// ========================================
// Event Handlers
// ========================================

$(document).ready(function() {
    // Initial load
    loadLogs();
    
    // Start auto-refresh
    startAutoRefresh();
    
    // Refresh button
    $('#refreshBtn').click(function() {
        loadLogs();
    });
    
    // Clear button
    $('#clearBtn').click(function() {
        clearDisplay();
    });
    
    // Auto-refresh checkbox
    $('#autoRefresh').change(function() {
        if ($(this).is(':checked')) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });
    
    // Refresh interval change
    $('#refreshInterval').change(function() {
        if ($('#autoRefresh').is(':checked')) {
            startAutoRefresh();
        }
    });
    
    // Number of lines change
    $('#numLines').change(function() {
        loadLogs();
    });
});

// Cleanup on page unload
$(window).on('beforeunload', function() {
    stopAutoRefresh();
});

</script>
</body>
</html>
